{% extends 'blog/base.html' %}
{% load crispy_forms_filters %}
{% block content %}


    <div class="card bg-dark text-light mb-4 shadow-sm border-0 rounded">
        <div class="card-body">
            <!-- Profile Info -->
            <div class="d-flex align-items-center mb-2">
                <!-- Profile Image -->
                <img src="{{ object.user_id.profile.image.url|default:'https://via.placeholder.com/50?text=U' }}"
                     alt="Profile"
                     class="rounded-circle mr-3 border border-secondary"
                     width="50" height="50">

                <!-- User Info + Date + 3-dot menu -->
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center">
                        <!-- Name & Username -->
                        <div>
                            <strong>{{ object.user_id.first_name }} {{ object.user_id.last_name }}</strong>
                            <span class="text-muted ml-1">@{{ object.user_id.username }}</span>
                        </div>

                        <!-- Date + Dropdown -->
                        <div class="d-flex align-items-center">
                            <small class="text-muted mr-2">{{ object.created_at|date:"M d, Y" }}</small>

                            {% if object.user_id == user %}
                                <!-- 3 Dot Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-sm text-light p-0 border-0 bg-transparent" type="button"
                                            id="postDropdown{{ object.id }}"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical" style="font-size: 1.2rem;"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right bg-dark text-light shadow-sm"
                                         aria-labelledby="postDropdown{{ object.id }}">
                                        <a class="dropdown-item text-light" href="{% url 'blog-update' object.id %}">
                                            <i class="bi bi-pencil-square mr-2"></i> Update Post
                                        </a>
                                        <form method="POST" action="{% url 'blog-delete' object.id %}" class="m-0 p-0">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-light"
                                                    style="background: none; border: none;">
                                                <i class="bi bi-trash mr-2"></i> Delete Post
                                            </button>
                                        </form>
                                    </div>
                                </div>

                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>


            <!-- Post Content -->
            <div class="mt-3 mb-3" style="font-size: 1.2rem;">
                <a href="{% url 'blog-detail' object.id %}" class="text-light text-decoration-none">
                    {{ object.content }}
                </a>
            </div>

            <!-- Media (centered, no bottom border) -->
            {% if object.media_set.all %}
                <!-- Bootstrap Carousel -->
                <div id="carouselPost{{ object.id }}" class="carousel slide mb-3" data-ride="carousel">
                    <div class="carousel-inner rounded overflow-hidden">
                        {% for media in object.media_set.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ media.file_url|default_if_none:'#' }}"
                                     class="d-block w-100"
                                     style="max-height: 400px; object-fit: cover; cursor: zoom-in;"
                                     data-toggle="modal"
                                     data-target="#imageModal{{ object.id }}{{ forloop.counter }}">
                            </div>
                        {% endfor %}
                    </div>

                    {% if object.media_set.all|length > 1 %}
                        <a class="carousel-control-prev" href="#carouselPost{{ object.id }}" role="button"
                           data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carouselPost{{ object.id }}" role="button"
                           data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    {% endif %}
                </div>

                <!-- Image Modals -->
                {% for media in object.media_set.all %}
                    <div class="modal fade" id="imageModal{{ object.id }}{{ forloop.counter }}" tabindex="-1"
                         role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                            <div class="modal-content bg-dark border-0">
                                <div class="modal-body p-0">
                                    <img src="{{ media.file_url|default_if_none:'#' }}"
                                         class="img-fluid w-100"
                                         style="object-fit: contain;">
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Buttons: No border, cleaner spacing -->
            <div class="d-flex justify-content-around mt-3">
                <div id="like-button-{{ post.id }}" hx-swap="outerHTML">
                    {% if post.id in liked_posts %}
                        {% include "partials/like_button.html" with post=post is_liked=True  total_likes=total_likes %}
                    {% else %}
                        {% include "partials/like_button.html" with post=post is_liked=False total_likes=total_likes %}
                    {% endif %}
                </div>

                <div id="comment-section-{{ post.id }}" hx-swap="outerHTML">
                    {% include "partials/comment_button.html" with post=post comment_form=comment_form %}
                </div>
                <button class="btn btn-sm text-light p-2">
                    <i class="bi bi-arrow-repeat mr-1"></i> Repost
                </button>
            </div>

            {% for comment in post.get_all_comments %}
                <div class="comment bg-dark text-light p-3 rounded mb-3 border border-secondary">

                    <!-- Header Row: Profile Image, Username, 3-dot menu -->
                    <div class="d-flex justify-content-between align-items-center mb-1">

                        <!-- Left: Profile Image + Name -->
                        <div class="d-flex align-items-center">
                            <img src="{{ comment.commented_by.profile.image.url }}"
                                 alt="Profile Picture"
                                 class="rounded-circle mr-2 border border-secondary"
                                 width="40" height="40">

                            <div>
                                <strong class="d-block">{{ comment.commented_by.get_full_name }}</strong>
                                <small class="text-muted">@{{ comment.commented_by.username }}</small>
                            </div>
                        </div>

                        <!-- Right: 3-dot dropdown menu -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-light rounded-circle" type="button"
                                    data-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right dropdown-menu-dark">

                                <button type="button" class="dropdown-item text" data-toggle="modal"
                                        data-target="#updateCommentModal{{ comment.id }}"  style="background: none; border: none;">
                                    <i class="bi bi-trash mr-2"></i> Update comment
                                </button>

                                <form method="POST" action="{% url 'blog-comment-delete' comment.id %}" class="m-0 p-0">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger"
                                            style="background: none; border: none;">
                                        <i class="bi bi-trash mr-2"></i> Delete Comment
                                    </button>
                                </form>

                            </div>
                        </div>

                        <!-- update comment Modal -->
                        <div class="modal fade" id="updateCommentModal{{ comment.id }}" tabindex="-1" role="dialog"
                             aria-labelledby="updateProfileModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content bg-dark text-light">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="updateProfileModalLabel">Update Profile</h5>
                                        <button type="button" class="close text-light" data-dismiss="modal"
                                                aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form method="POST" enctype="multipart/form-data"
                                              action="{% url 'blog-comment-update' comment.id%}">
                                            {% csrf_token %}
                                            {{ comment_form|crispy }}
                                            <button type="submit" class="btn btn-light rounded-pill">Save Changes
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Comment Text -->
                    <p class="mb-2">{{ comment.comment }}</p>

                    <!-- Reply Button -->
                    <button class="btn btn-sm btn-outline-info rounded-pill">
                        <i class="bi bi-reply-fill mr-1"></i> Reply
                    </button>

                </div>
            {% endfor %}

        </div>
    </div>
{% endblock %}
